<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1b4b">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta charset="UTF-8">
    <title>IT Admin Console | BDFB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e1b4b; --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --accent: #4f46e5; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 2rem; margin: 0; color: #0f172a; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; background: var(--primary); padding: 1.5rem; border-radius: 16px; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .btn-back { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 600; text-decoration: none; transition: 0.2s;}
        .btn-back:hover { background: rgba(255,255,255,0.25); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .card { background: var(--surface); padding: 2rem; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: var(--primary); font-size: 1.25rem; margin-bottom: 0.5rem; }
        
        .form-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; margin-bottom: 1.5rem; box-sizing: border-box; font-family: 'Inter', sans-serif; text-transform: uppercase; }
        .btn-action { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; color: white; background: var(--accent); font-size: 1rem; transition: 0.2s; }
        .btn-action:hover { background: #4338ca; }
        
        .upload-zone { border: 2px dashed #cbd5e1; padding: 2.5rem 2rem; text-align: center; border-radius: 12px; cursor: pointer; background: #f8fafc; margin-top: 1rem; transition: 0.2s; }
        .upload-zone:hover { border-color: var(--accent); background: #eef2ff; }

        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } body { padding: 1rem; } .header { flex-direction: column; gap: 15px; text-align: center; } }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0;">‚öôÔ∏è IT Admin Console</h1>
            <p style="margin:5px 0 0 0; opacity:0.8;">System Configuration & Master Controls</p>
        </div>
        <a class="btn-back" href="index.html">‚Üê Back to Dashboard</a>
    </div>

    <div class="grid">
        <div class="card">
            <h2>üõ†Ô∏è Assign System Roles</h2>
            <p style="color:gray; font-size:0.9rem; margin-bottom:1.5rem;">Elevate standard users to HR, HOD, or IT Admin status.</p>
            
            <label style="font-weight:bold; display:block; margin-bottom:8px;">1. Enter Employee ID:</label>
            <input type="text" id="user-id-input" class="form-input" placeholder="e.g. BDB133">

            <label style="font-weight:bold; display:block; margin-bottom:8px;">2. Assign Access Role:</label>
            <select id="role-select" class="form-input" style="text-transform: none;">
                <option value="EMPLOYEE" selected>Standard Employee (Default)</option>
                <option value="HOD">HOD (Head of Department)</option>
                <option value="HR">HR (Human Resources)</option>
                <option value="ADMIN">IT Admin (Full Access)</option>
            </select>
            
            <button class="btn-action" onclick="updateRole()">Update Access Privileges</button>
        </div>

        <div class="card">
            <h2>üìÖ Sync Biometric Logs</h2>
            <p style="color:gray; font-size:0.9rem;">Upload daily or monthly .CSV files generated by the biometric scanner.</p>
            <div class="upload-zone" style="background:#f0fdf4; border-color:#86efac;" onclick="document.getElementById('dailyInput').click()">
                <div style="font-size:2.5rem; margin-bottom:10px;">üöÄ</div>
                <strong style="color:#166534; font-size:1.1rem;">Click to Upload Attendance CSV</strong>
            </div>
            <input type="file" id="dailyInput" style="display:none;" onchange="uploadData()">
        </div>

        <div class="card" style="grid-column: 1 / -1; max-width: 600px; margin: 0 auto; width: 100%;">
            <h2>üë• Upload Employee Master Directory</h2>
            <p style="color:gray; font-size:0.9rem;">Mass-create or update employee accounts using a CSV file.</p>
            <div class="upload-zone" onclick="document.getElementById('dirInput').click()">
                <div style="font-size:2.5rem; margin-bottom:10px;">üë§</div>
                <strong style="font-size:1.1rem; color:var(--primary);">Click to Upload Master List (CSV)</strong>
            </div>
            <input type="file" id="dirInput" style="display:none;" onchange="uploadDirectory()">
        </div>
    </div>

    <script>
        // ON LOAD: Verify Admin Status ONLY
        window.onload = () => {
            const session = JSON.parse(localStorage.getItem('bdfb_session'));
            if(!session || session.role !== 'ADMIN') { 
                alert('Access Denied. IT Admin Privileges Required.'); 
                window.location.href='index.html'; 
            }
        };

        // FUNCTION: Update Role
        async function updateRole() {
            const empId = document.getElementById('user-id-input').value.trim().toUpperCase();
            const role = document.getElementById('role-select').value;
            
            if(!empId) return alert("Please enter an Employee ID first!");

            try {
                const res = await fetch('/api/admin/update-role', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ empId: empId, role: role })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    alert(`‚úÖ Success: ${empId} is now assigned as ${role}.`);
                    document.getElementById('user-id-input').value = ''; // Clear box
                } else {
                    alert(`‚ùå Error: ${data.message}`);
                }
            } catch (e) {
                alert("Failed to update role. Ensure backend is running.");
            }
        }

        // FUNCTION: Upload Biometric Data
        async function uploadData() {
            const file = document.getElementById('dailyInput').files[0];
            if (!file) return;

            const formData = new FormData(); 
            formData.append("file", file);
            
            document.querySelector('.upload-zone strong').innerText = "Uploading & Processing... Please wait.";

            try {
                const res = await fetch('/api/admin/upload-logs', { method: 'POST', body: formData });
                if(res.ok) {
                    alert("‚úÖ Biometric Database Synchronized successfully!");
                    location.reload();
                } else {
                    alert("‚ùå Error processing file.");
                    location.reload();
                }
            } catch(e) {
                alert("Upload failed. Connection error.");
                location.reload();
            }
        }

        // FUNCTION: Upload Directory
        async function uploadDirectory() {
            const file = document.getElementById('dirInput').files[0];
            if (!file) return;

            const formData = new FormData(); 
            formData.append("file", file);
            
            try {
                const res = await fetch('/api/admin/upload-directory', { method: 'POST', body: formData });
                const data = await res.json();
                alert(`‚úÖ Processed ${data.usersCreated || 0} Employee Accounts.`);
                location.reload();
            } catch(e) {
                alert("Directory upload failed.");
                location.reload();
            }
        }
    </script>
</body>
</html>